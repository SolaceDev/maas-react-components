<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRC Usage Report Workflow Architecture</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #0052cc;
            border-bottom: 2px solid #0052cc;
            padding-bottom: 5px;
        }
        h1 {
            font-size: 2.5em;
        }
        h2 {
            font-size: 2em;
        }
        h3 {
            font-size: 1.5em;
        }
        p {
            margin-bottom: 15px;
        }
        ul, ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        code {
            background-color: #eee;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
        }
        .mermaid {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #0052cc;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>MRC Usage Report Workflow Architecture</h1>
    <p>This document outlines the architecture and workflow of the MRC (MaaS React Components) Usage Report generation system. The system is designed to automatically scan various application codebases, generate a comprehensive report on component usage, and make this data available for querying and analysis.</p>
    <h2>Architecture Diagram</h2>
    <pre class="mermaid">
%%{init: {'theme': 'forest'}}%%
sequenceDiagram
    participant Scheduler as mrc-usage-report-scheduler.yml
    participant Worker as mrc-usage-report-worker.yml
    participant ReportTool as mrc-usage-report tool
    participant DataBranch as feature/mrc-usage-report-data
    participant MCP as mrc-usage-mcp tool

    Scheduler->>Worker: Triggers workflow daily (8 AM EST)
    Worker->>Worker: Checkout Repos (maas-react-components, maas-ui, etc.)
    Worker->>ReportTool: Run scan on codebases
    ReportTool->>Worker: Generate mrc-usage-report-all.json
    Worker->>Worker: Run mrc-usage-report-json-splitter
    Worker->>DataBranch: Commit structured data to mrc-usage-report-data folder
    MCP->>DataBranch: Read structured data via GitHub API
    </pre>
    <h2>Components</h2>
    <h3><code>mrc-usage-report-scheduler.yml</code></h3>
    <ul>
        <li><strong>Purpose</strong>: Acts as a simple and reliable timer that triggers the <code>mrc-usage-report-worker.yml</code> workflow.</li>
        <li><strong>Responsibilities</strong>:
            <ul>
                <li><strong>Trigger</strong>: Uses a <code>schedule</code> event to run automatically at a specified time (daily at 8 AM EST / 12 PM UTC).</li>
                <li><strong>Invoke Worker</strong>: Dispatches a <code>workflow_dispatch</code> event to trigger the <code>mrc-usage-report-worker.yml</code> workflow, passing any necessary inputs.</li>
            </ul>
        </li>
        <li><strong>Branch</strong>: Resides on the <code>main</code> branch to comply with GitHub's requirements for scheduled workflows.</li>
    </ul>
    <h3><code>mrc-usage-report-worker.yml</code></h3>
    <ul>
        <li><strong>Purpose</strong>: Contains the primary logic for generating the MRC usage report.</li>
        <li><strong>Responsibilities</strong>:
            <ul>
                <li><strong>Checkout Source</strong>: Checks out the <code>maas-react-components</code> repository to gain access to the reporting tools.</li>
                <li><strong>Checkout Targets</strong>: Checks out the target application repositories (<code>maas-ui</code>, <code>maas-ops-ui</code>, <code>broker-manager</code>) into a local directory.</li>
                <li><strong>Run Report Tool</strong>: Executes the <code>mrc-usage-report</code> tool, pointing it at the checked-out application codebases.</li>
                <li><strong>Process Report</strong>: Runs the <code>mrc-usage-report-json-splitter</code> script to transform the single large JSON report into a structured, directory-based format.</li>
                <li><strong>Commit Data</strong>: Configures Git with a bot identity, then adds, commits, and pushes the structured data to the <code>mrc-usage-report-data</code> folder in the <code>feature/mrc-usage-report-data</code> branch.</li>
                <li><strong>Upload Artifacts</strong>: Uploads the generated raw reports (<code>mrc-usage-report-all.json</code>, etc.) as build artifacts for debugging and historical records.</li>
            </ul>
        </li>
        <li><strong>Trigger</strong>: Can be triggered by <code>mrc-usage-report-scheduler.yml</code> via <code>workflow_dispatch</code> or manually.</li>
    </ul>
    <h3><code>mrc-usage-report</code> tool</h3>
    <ul>
        <li><strong>Purpose</strong>: A command-line utility that scans the source code of specified applications to identify how and where MaaS React Components are used.</li>
        <li><strong>Responsibilities</strong>:
            <ul>
                <li><strong>Discover MFEs</strong>: Scans the directory structure of each application to identify Micro-Frontends (MFEs) by looking for <code>package.json</code> files.</li>
                <li><strong>Find Source Files</strong>: Within each MFE, it finds all relevant source files (<code>.ts</code>, <code>.tsx</code>, <code>.js</code>, <code>.jsx</code>).</li>
                <li><strong>Parse Imports</strong>: Parses each file to create an Abstract Syntax Tree (AST) and identifies <code>import</code> statements from <code>@solace-community/maas-react-components</code>.</li>
                <li><strong>Identify Usage</strong>: Traverses the AST to find where the imported components are used as JSX elements.</li>
                <li><strong>Extract Props</strong>: For each component instance found, it extracts the names and values of all props being passed to it.</li>
                <li><strong>Aggregate Data</strong>: Compiles the collected data (application, MFE, file path, component name, props) into a single, comprehensive data structure.</li>
                <li><strong>Generate Reports</strong>: Outputs the aggregated data into multiple formats, including a detailed <code>mrc-usage-report-all.json</code> and a human-readable HTML report.</li>
            </ul>
        </li>
    </ul>
    <h3><code>mrc-usage-mcp</code> tool</h3>
    <ul>
        <li><strong>Purpose</strong>: A Model Context Protocol (MCP) server that provides a queryable API for the generated component usage data.</li>
        <li><strong>Responsibilities</strong>:
            <ul>
                <li><strong>Initialize</strong>: On startup, the server initializes a GitHub API client using a provided token.</li>
                <li><strong>Listen for Queries</strong>: It exposes a set of tools (e.g., <code>get_component_usage_all</code>, <code>get_component_usage_by_mfe</code>) that can be called by an MCP client.</li>
                <li><strong>Fetch Data</strong>: When a query is received, it makes a request to the GitHub API to fetch the directory listing and file contents from the <code>mrc-usage-report-data</code> folder on the <code>feature/mrc-usage-report-data</code> branch.</li>
                <li><strong>Process and Serve</strong>: It parses the JSON data from the fetched files, filters it according to the query parameters, and returns the result to the client.</li>
            </ul>
        </li>
    </ul>
    <h2>Workflow Description</h2>
    <p>The following steps describe the end-to-end process of generating and consuming the MRC usage report:</p>
    <ol>
        <li><strong>Schedule Trigger</strong>: The <code>mrc-usage-report-scheduler.yml</code> workflow, running on a daily schedule, initiates the process.</li>
        <li><strong>Worker Invocation</strong>: The scheduler triggers the <code>mrc-usage-report-worker.yml</code> workflow using a <code>workflow_dispatch</code> event.</li>
        <li><strong>Code Checkout</strong>: The worker checks out the latest versions of the required application repositories.</li>
        <li><strong>Scanning and Reporting</strong>: The worker executes the <code>mrc-usage-report</code> command-line tool. The tool scans the checked-out code and generates a single, large JSON file named <code>mrc-usage-report-all.json</code>.</li>
        <li><strong>Data Processing</strong>: The worker then runs the <code>mrc-usage-report-json-splitter</code> tool. This script processes <code>mrc-usage-report-all.json</code> and breaks it down into a more structured, queryable format (e.g., one file per component per MFE).</li>
        <li><strong>Data Persistence</strong>: The worker commits the structured data files to the <code>mrc-usage-report-data</code> folder within the <code>feature/mrc-usage-report-data</code> branch.</li>
        <li><strong>API Access</strong>: The <code>mrc-usage-mcp</code> server is configured to read data from the <code>feature/mrc-usage-report-data</code> branch. It fetches the structured JSON files via the GitHub API to serve queries about component usage.</li>
    </ol>
    <h2>Design Decisions</h2>
    <h3>Why are the scheduler and worker in separate workflow files?</h3>
    <p>The scheduler is separated from the worker to create a clean, single-purpose timer. GitHub requires scheduled workflows to be on the default branch (<code>main</code>). The worker logic, however, operates on a feature branch (<code>feature/mrc-usage-report-data</code>) to commit its results. This separation allows the scheduler to remain on <code>main</code> while the worker can be developed and tested on its own branch without affecting the production schedule.</p>
    <h3>Why is the report data stored in a separate branch?</h3>
    <p>The generated report data is stored in the <code>feature/mrc-usage-report-data</code> branch to isolate it from the main codebase. This prevents the main development branches from being cluttered with frequently updated, auto-generated data. It also provides a stable, independent location for the <code>mrc-usage-mcp</code> server to fetch data from.</p>
    <h3>Why does the MCP server fetch data from GitHub directly?</h3>
    <p>The <code>mrc-usage-mcp</code> server fetches data directly from the GitHub repository via its API. This decouples the data source from the server's deployment. The server doesn't need access to a local file system or a separate database, simplifying its architecture. It can be run anywhere and still access the most up-to-date usage data as long as it has a GitHub token.</p>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
</body>
</html>