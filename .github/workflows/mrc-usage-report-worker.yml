name: MRC Usage Report Generation

on:
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write # For checking out repositories and committing
    outputs:
      artifact_url: ${{ steps.merged-reports-artifact.outputs.artifact-url }}
    steps:
      - name: Checkout maas-react-components (current repo)
        uses: actions/checkout@v4
        with:
          ref: feature/mrc-usage-report-data
          path: maas-react-components-repo

      - name: Checkout maas-react-components (main)
        uses: actions/checkout@v4
        with:
          ref: main
          path: maas-react-components-repo-main

      - name: Print directory structure (maas-react-components)
        run: |
          echo "==== DIRECTORY STRUCTURE INFORMATION ===="
          echo "Current working directory: $(pwd)"
          echo "maas-react-components-repo location: $(pwd)/maas-react-components-repo"
          ls -la maas-react-components-repo

      - name: Checkout maas-ui
        uses: actions/checkout@v4
        with:
          repository: SolaceDev/maas-ui
          ref: develop
          path: maas-ui
          token: ${{ secrets.PACKAGES_ADMIN_TOKEN }}

      - name: Print directory structure (maas-ui)
        run: |
          echo "==== MAAS-UI DIRECTORY STRUCTURE ===="
          echo "maas-ui-repo location: $(pwd)/maas-ui"
          ls -la maas-ui
          echo "maas-ui-repo/tools location: $(pwd)/maas-ui/tools"
          ls -la maas-ui/tools || echo "tools directory not found"
          echo "maas-ui-repo/tools/mrc-usage-report location: $(pwd)/maas-ui/tools/mrc-usage-report"
          ls -la maas-ui/tools/mrc-usage-report || echo "mrc-usage-report directory not found"

      - name: Checkout maas-ops-ui
        uses: actions/checkout@v4
        with:
          repository: SolaceDev/maas-ops-ui
          ref: develop
          path: maas-ops-ui
          token: ${{ secrets.PACKAGES_ADMIN_TOKEN }}

      - name: Print directory structure (maas-ops-ui)
        run: |
          echo "==== MAAS-OPS-UI DIRECTORY STRUCTURE ===="
          echo "maas-ops-ui-repo location: $(pwd)/maas-ops-ui"
          ls -la maas-ops-ui
          echo "maas-ops-ui-repo/tools location: $(pwd)/maas-ops-ui/tools"
          ls -la maas-ops-ui/tools || echo "tools directory not found"
          echo "maas-ops-ui-repo/tools/mrc-usage-report location: $(pwd)/maas-ops-ui/tools/mrc-usage-report"
          ls -la maas-ops-ui/tools/mrc-usage-report || echo "mrc-usage-report directory not found"
          echo "maas-ops-ui-repo/tools/mrc-report-merger location: $(pwd)/maas-ops-ui/tools/mrc-report-merger"
          ls -la maas-ops-ui/tools/mrc-report-merger || echo "mrc-report-merger directory not found"
          echo "maas-ops-ui-repo/tools/json-splitter location: $(pwd)/maas-ops-ui/tools/json-splitter"
          ls -la maas-ops-ui/tools/json-splitter || echo "json-splitter directory not found"

      - name: Checkout broker manager
        uses: actions/checkout@v4
        with:
          repository: SolaceDev/broker-manager
          ref: main
          path: broker-manager
          token: ${{ secrets.PACKAGES_ADMIN_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Generate all usage reports
        run: |
          npm i
          npm run build
          npm start -- --all --maas-ui-path ../../../maas-ui --maas-ops-ui-path ../../../maas-ops-ui --broker-manager-path ../../../broker-manager --format html
          npm start -- --all --maas-ui-path ../../../maas-ui --maas-ops-ui-path ../../../maas-ops-ui --broker-manager-path ../../../broker-manager --format json
        working-directory: maas-react-components-repo/tools/mrc-usage-report

      - name: Split merged JSON
        run: |
          echo "==== SPLIT MERGED JSON ===="
          echo "Current working directory: $(pwd)"
          ls -la
          echo "Checking for input file:"
          ls -la ../mrc-usage-report/reports/mrc-usage-report-all.json || echo "merged-report.json not found"
          echo "Creating reports directory if it doesn't exist..."
          echo "Installing dependencies..."
          npm install

          npm install
          npm run build

          echo "Running npm start with parameters..."
          npm start -- -i ../mrc-usage-report/reports/mrc-usage-report-all.json -o ../../../maas-react-components-repo/mrc-usage-report-data-new
          echo "--- Verifying contents of output directory ---"
          pwd
          ls -lR ../../../maas-react-components-repo/mrc-usage-report-data-new
          echo "Listing generated files:"
          find . -type f -name "*.json" | sort
          echo "Contents of first split file (if any):"
          find . -type f -name "*.json" | sort | head -n 1 | xargs cat || echo "No split files found"
        working-directory: maas-react-components-repo/tools/mrc-usage-report-json-splitter

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp maas-react-components-repo/tools/mrc-usage-report/reports/*.html artifact/
          cp maas-react-components-repo/tools/mrc-usage-report/reports/*.json artifact/
          cp -r maas-react-components-repo/mrc-usage-report-data artifact/

      - name: Upload merged reports
        id: merged-reports-artifact
        uses: actions/upload-artifact@v4
        with:
          name: merged-reports
          path: artifact/

      - name: Validate generated report
        working-directory: maas-react-components-repo/tools/mrc-usage-report
        run: |
          npm run validate-report

      - name: Swap and commit report data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd maas-react-components-repo
          # Remove the old report data directory completely
          rm -rf mrc-usage-report-data
          # Move the new, validated data into place
          mv mrc-usage-report-data-new mrc-usage-report-data
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add mrc-usage-report-data
          COMMIT_MESSAGE="feat: add mrc usage report data for $(date +'%Y-%m-%d %H:%M')"
          git commit --no-verify -m "$COMMIT_MESSAGE"
          git push
