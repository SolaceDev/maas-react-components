name: "On Push to Main"

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
permissions:
  contents: write
  packages: write
  id-token: write
  pull-requests: write
  actions: read
  statuses: write
  checks: write
  repository-projects: read

jobs:
  chromatic-deployment:
    name: "Deploy Storybook to Chromatic"
    # Operating System
    runs-on: ubuntu-latest
    # Job steps
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc
          echo "@SolaceDev:registry=https://npm.pkg.github.com/" >> .npmrc
          echo "legacy-peer-deps=true" >> .npmrc
          npm ci && npm --prefix storybook i
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }} #need this for npm package.
        # ðŸ‘‡ Adds Chromatic as a step in the workflow

      - name: Publish to Chromatic
        # publish
        uses: chromaui/action@latest
        # Chromatic GitHub Action options
        with:
          # ðŸ‘‡ Chromatic projectToken, refer to the manage page to obtain it.
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # storybook directory
          workingDir: storybook
          exitZeroOnChanges: false

      - name: Run FOSSA Scan
        uses: fossas/fossa-action@v1.7.0 # Use a specific version if locking is preferred
        continue-on-error: true
        with:
          api-key: ${{secrets.FOSSA_API_KEY}}

      - name: Perform WhiteSource Scan
        id: whitesource_scan
        uses: SolaceDev/solace-public-workflows/.github/actions/whitesource-scan@main
        continue-on-error: true
        with:
          whitesource_api_key: ${{ secrets.WHITESOURCE_API_KEY }}
          whitesource_product_name: ${{ vars.WHITESOURCE_PRODUCT_NAME }}
          whitesource_project_name: ${{ github.event.repository.name }}
          target_directory: "."

  bump-version:
    needs: chromatic-deployment
    name: "Bump Version on main"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v4"
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.COMMIT_KEY }}
          fetch-depth: 0

      - name: "cat package.json"
        run: cat ./package.json

      - name: "Automated Version Bump"
        id: bump
        uses: "phips28/gh-action-bump-version@master"
        with:
          minor-wording: "solaceminor,SolaceMinor,SOLACEMINOR"
          major-wording: "solacemajor,SolaceMajor,SOLACEMAJOR"
          patch-wording: "solacepatch,SolacePatch,SOLACEPATCH"
          tag-prefix: ""
          commit-message: "CI: bumps version to {{version}} [skip ci]" # Add skip ci tag
          skip-push: "true"
        env:
          #Required for version bumping and by-passing branch protection
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: "cat package.json"
        run: cat ./package.json

      - name: Set up SSH agent
        if: steps.bump.outputs.newTag != ''
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.COMMIT_KEY }}

      # The git push command, now authenticated with the SSH key
      - name: Push new version and tag
        if: steps.bump.outputs.newTag != ''
        run: |
          # The `phips28` action will have already committed the changes.
          # We just need to push them to the remote.
          # NOTE: The email "41898282+github-actions[bot]@users.noreply.github.com" is required
          # so that GitHub recognizes the commit as made by the GitHub Actions bot,
          # which helps with permissions and attribution.
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin git@github.com:${{ github.repository }}.git
          git push
          git push origin ${{ steps.bump.outputs.newTag }}
